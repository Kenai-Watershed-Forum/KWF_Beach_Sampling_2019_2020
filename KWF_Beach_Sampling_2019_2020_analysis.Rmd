---
title: "KWF_Beach_Sampling_Analysis_2019_2020"
output:
  html_document: 
    fig_width: 10
    fig_height: 6
    fig_caption: yes
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
      smooth_scroll: no
editor_options: 
  chunk_output_type: inline
---

Document last updated `r Sys.time()` by Benjamin Meyer ([ben\@kenaiwatershed.org](mailto:ben@kenaiwatershed.org){.email})

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

# clear environment
rm(list=ls())

# load packages
library(tidyverse)
library(lubridate)
library(readr)
library(readxl)
library(writexl)
library(hms)
library(plotly)
library(DT)
library(xlsx)
library(leaflet)
library(DT)
library(ggpubr)
library(plotrix)
library(zoo)
library(psych)
library(janitor)
library(scales)

select <- dplyr::select

# set plotting themes

## geom_col plots theme
col_theme <- theme(axis.title = element_text(size = 14, face = "bold"),
                   strip.text = element_text(size = 14, face = "bold"),
                   legend.title = element_text(size = 14, face = "bold"),
                   legend.text = element_text(size = 14),
                   axis.text = element_text(size = 14))

## geom_points plots theme
points_theme <- theme(axis.title = element_text(size = 14, face = "bold"),
                   strip.text = element_text(size = 14, face = "bold"),
                   legend.title = element_text(size = 14, face = "bold"),
                   legend.text = element_text(size = 14),
                   axis.text = element_text(size = 14),
                   title = element_text(size = 18))

# function to exclude multiple items per column
'%ni%' <- Negate('%in%')
```

<br>

This draft document contains preliminary data explorations of 2019-2020 beach bacteria sampling data from the Kenai River Watershed.

<br>

Notes:

-   Sourced data from AWQMS files and other files found on KWF local server.

-   2020 Microbial Source Tracing data is present in AWQMS files, 2019 MST data is not. Sourced 2019 MST data from "MST results 2019.xlsx"

-   In the future, request that SGS can provide sample results in .csv or .xlsx format in addition to the PDFs to eliminate potential for data entry or data management error.

<br>

------------------------------------------------------------------------

### Read in data

```{r}

# import known data from local server source

# specify column import names
vars <- as.character(c("Monitoring Location Name",
            "Activity Latitude",
            "Activity Longitude",
            "Activity Medium",
            "Activity Start Date",
            "Activity Start Time",
            "Characteristic Name",
            "Result Analytical Method",
            "Result Value",
            "Result Value Units",
            "Result Qualifier"))

# specify new column names
new_vars <- as.character(c("location",
            "lat",
            "long",
            "medium",
            "date",
            "time",
            "data_type",
            "analytical_method",
            "val",
            "units",
            "qualifier"))


# import 2019 AWQMS data
## used this excel file because it had the most recent modified date
## see notes in excel file; not sure if all available data is contained within here
bs19 <- read_excel("data/KWF_2019_Kenai-BEACH_AWQMS_forQAQC_MH101119.xlsx", sheet = "AWQMS Data Template", skip = 7) %>%
  select(all_of(vars))

# import 2020 AWQMS data
## see notes in excel file; not sure if all avilable data is contained within here
bs20 <- read_excel("data/2020_KWF_Kenai-BEACH_AWQMS_SUBMITTED.xlsx", sheet = "RAW AWQMS Data Template", skip = 3) %>%
  select(all_of(vars))

# combine both years
dat <- bind_rows(bs19,bs20)

# rename columns
colnames(dat) <- new_vars

## 2019 MST data absent from AWQMS file.  So, import separately and format to join
## imported sheet was created manually on 12/8/20 from the sheet titled "Summary"
mst19 <- read_excel("data/MST results 2019.xlsx", sheet = "AWQMS_summary_format") %>%
  select(-site_id)

# join 2019 MST data to overall data set
dat <- bind_rows(dat,mst19)

# tidy column formats
dat <- dat %>%
  transform(time = hms::as_hms(time))

# replace "Gull_Gull-#" with "Gull_Gull-4"
# correct location names
dat <- dat %>%
  mutate(analytical_method = str_replace_all(analytical_method,c("Gull_Gull-5" = "Gull_Gull-4",
                                                                 "Gull_Gull-6" = "Gull_Gull-4"))) %>%
  mutate(location = str_replace_all(location, c("North Kenai River Beach 4" = "North Kenai Beach 4"))) %>%
  # include only water quality data
  # bacteria concs and temperature
  filter(medium == "Water")

rm(bs19,bs20,mst19)
                                             
```

<br>

How many bacteria sample values all together do we have; including replicates?

```{r}
dat %>%
  filter(data_type %in% c("Enterococci","Fecal Coliform")) %>%
  group_by(data_type) %>%
  summarise(n = n())
```

Notes post data read-in:

-   Air temperature values are all negative integers (maybe a code? do not use air temperature data from this data set)
-   Applied name correction to reconcile equivalent "North Kenai Beach 4" and "North Kenai River Beach 4" sites.
-   Some unit designations are missing (turbidity, weather condition, wind direction, others?)
-   Some Microbial Source Tracking analytic method ID is entered as "Gull_Gull-\#" (e.g. 5, 6, 7, etc) when the only designation for this method should be "Gull_Gull-4." Likely occurred from an excel drag-down at some point in data entry.
-   Many observations in "val" column are character (e.g. "MODERATE", "ND", etc). Caution when converting this column to numeric.
-   Verified that "NA" observations in the value column are actually absent, checked original PDF files from SGS.
-   Replicate values are present (from replicate samples)

<br>

Procedure:

-   Recreate tables (approximately) found in provided excel file ("2020 Beach Sampling Compiled Results_FINALREPORT.xlsx") to verify values
-   Create figures to visualize exceedence data

<br>

------------------------------------------------------------------------

<br>

### Replicate sample values

Address replicate sample values

-   How many replicate samples do we have?

```{r}
# how many replicate samples do we have?
rep_ct <- dat %>%
  filter(data_type %in% c("Enterococci","Fecal Coliform","Microbial Source Tracking")) %>%
  group_by(location,date,time,data_type) %>%
  count(name = "rep_set") %>%
  ungroup() %>%
  filter(rep_set > 1) %>%
  group_by(data_type,rep_set) %>%
  count(name = "count")

datatable(rep_ct)

  
```

The 2019 - 2020 data set has a number of sample values where a paired replicate also exists, both for bacteria concentration values and microbial source tracking values.

<br>

What is the average difference between replicate values? (by sample type)

```{r}
# what is the average % difference among duplicates? (by sample type)
rep_diff <- dat %>%
  filter(data_type %in% c("Enterococci","Fecal Coliform","Microbial Source Tracking")) %>%
  group_by(location,date,analytical_method) %>%
  filter(n() > 1) %>%
  arrange(location,date,analytical_method) %>%
  transform(val = as.numeric(val)) %>%
  select(location,date,data_type,val) %>%
  group_by(location,date,data_type) %>%
  # calculate percent difference between instances of two replicate samples
  mutate(diff = abs(lag(val) - val)) %>%
  mutate(lagsum = val + lag(val)) %>%
  mutate(pct_diff = (diff / (lagsum/2))*100)  %>%
  select(location,date,data_type,val,pct_diff)  %>%
  fill(pct_diff, .direction = "up")

datatable(rep_diff,
          filter = 'top', 
          options = list(pageLength = 5, autoWidth = TRUE))
```

<br>

Replicate difference summary table
```{r}

# summarise
rep_diff_summary <- rep_diff %>%
  group_by(data_type) %>%
  summarise(n = n(),
            mean = mean(pct_diff),
            se = std.error(pct_diff))
colnames(rep_diff_summary) <- c("Bacteria","n","Mean % Difference","Std. Error % Difference")

# print table
datatable(rep_diff_summary,
          filter = 'top', 
          options = list(pageLength = 5, autoWidth = TRUE))


# export table
write.csv(rep_diff_summary,"output/rep_diff_summary.csv",row.names = F)

# plot 1
rep_diff %>%
  ggplot(aes(val,pct_diff,color = data_type)) +
  geom_point()

# plot 2
rep_diff %>%
  mutate(day = yday(date)) %>%
  ggplot(aes(day,pct_diff,color = data_type)) +
  geom_point()

```

A relationship between magnitude of sample value or date and percent difference between duplicate samples is not readily apparent.

<br>

As per ADEC CALM protocol, where two replicate values exist, only the higher of the two values are used in further analyses.

***

<br>

```{r}
# mst sample values are in sets of 3 and have alphabetical characters for concentrations, so them treat separately
mst_dat <- dat %>%
  filter(data_type == "Microbial Source Tracking")


# prep bacteria concentrations dataframe
dat  <- dat %>%
  filter(data_type %in% c("Enterococci","Fecal Coliform")) %>%  
  group_by(location,lat,long,medium,data_type,analytical_method,units,qualifier,date,time) %>%
  
  # where pairs of two replicate samples exist, retain only the higher of the two values.  
  ## For example: South Kenai Beach 3 Enterococci 2019-05-21, rep1 = 4, rep 2 = 5; retains only rep1 = 4
  filter(val == max(val)) %>%
  
  # in some cases, when two replicate values are present, they are identical (e.g. rep1 = 1, rep2 = 1).  where equivalencies exist, we want to retain only one of the values
  ungroup() %>%
  group_by(location,lat,long,medium,data_type,analytical_method,units,qualifier,date,time,val) %>%
  summarise(val = mean(as.numeric(val))) %>%
  
  # and, in some cases, where two identical values exist, one may have a qualifier (e.g. "U") and the other does not
  ## We want to retain the one without the qualifier (e.g. "higher" value)
  ## remove 'qualifier' as grouping factor but keep it as a column
  ungroup() %>%
  distinct(location,lat,long,medium,data_type,analytical_method,units,date,time,val, .keep_all = T)

```

### Microbial Source Tracking

#### MST Data Table

```{r}
# recreate table in tab "2019-2020_FinalReport_MST2020"
mst_tbl <- mst_dat %>%
  arrange(location,date,analytical_method) %>%
  transform(date = as.Date(date)) %>%
  select(date,location,analytical_method,val) %>%
  pivot_wider(names_from = analytical_method, values_from = val) %>%
  arrange(date,location)

colnames(mst_tbl) <- c("Date","Location","Dog Feces","Gull Feces","Human Feces")

# print
datatable(mst_tbl,
          filter = 'top', 
          options = list(pageLength = 5, autoWidth = TRUE))

# save mst data table
write.csv(mst_tbl, "output/mst_summary_table.csv", row.names = F)

```

<br>

What is the range of concentration values for each species?

```{r}
mst_dat %>% 
  mutate(val = str_replace_all(val,c("ND" = "0",
                                     "DNQ" = "0"))) %>%
  transform(val = as.numeric(val)) %>%
  group_by(analytical_method) %>%
  summarise(min = min(val),
            max = max(val),
            mean = mean(val))
  
```

<br>

#### MST Results Figure

```{r}
# prep table for plot
mst_tbl <- mst_dat %>%
  filter(data_type == "Microbial Source Tracking") %>%
  arrange(location,date,analytical_method) %>%
  select(date,location,analytical_method,val) %>%
  # replace results DNQ and ND with zero and convert to numeric
  mutate(val = as.numeric(str_replace_all(val,c("DNQ" = "0", "ND" = "0"))))

# plot
mst_tbl %>%
  ggplot(aes(as.factor(date),val, fill = analytical_method)) +
  geom_col(position = "dodge") +
  facet_grid(.~location, labeller = labeller(location = label_wrap_gen(5))) +
  xlab("") +
  ylab("Concentration (Copies/100 mL)") +
  theme_bw() +
   # modify legend
  scale_fill_discrete(name="Source",
                         breaks=c("Dog_BacCan-UCD", "Gull_Gull-4", "Human_HF183"),
                         labels=c("Dog", "Gull", "Human")) +
  # theme 
  theme(axis.text.x = element_text(vjust = .5, angle = 85),
        strip.text.y = element_text(angle = 0)) +
  col_theme

# save plot
ggsave("output/mst_kenai_beach_2019_2020.png", width = 12, height = 6)
```

<br>

------------------------------------------------------------------------

### Enterococci and Fecal Coliform Concentrations

#### Bacteria Concentrations Data Table

```{r}
# prep table
bac_tbl <- dat %>% 
  filter(data_type %in% c("Enterococci","Fecal Coliform")) %>% 
  arrange(location,date,data_type) %>%
  select(date,location,data_type,val) %>%
  # replace results DNQ and ND with zero and convert to numeric
  mutate(val = as.numeric(str_replace_all(val,c("DNQ" = "0", "ND" = "0")))) %>%
  # use day of year for x axis and year for facet grid
  mutate(day = yday(date),
         year = year(date))

# print
datatable(bac_tbl,
          filter = 'top', 
          options = list(pageLength = 5, autoWidth = TRUE))

```

<br>

#### Bacteria Concentrations Figures

```{r, fig.height=10, fig.width=12}
# plot 1
bac_tbl %>%
  ggplot(aes(x = as.Date(paste(2014,strftime(date,format="%m-%d"),sep="-")),
                           y = val, 
                           color = as.factor(year))) +
  geom_jitter(size = 3) +
  facet_grid(location~data_type, labeller = labeller(location = label_wrap_gen(5))) +
  xlab("") +
  ylab("Individual Sample Concentration (CFU/100 mL)") +
  scale_color_discrete(name = "Year")+
  # theme
  theme_bw() +
  theme(axis.text.x = element_text(vjust = 1),
        strip.text.y = element_text(angle = 0)) +
  points_theme +
  ggtitle("Bacteria Raw Concentrations")

# save plot
ggsave("output/bacteria_conc_2019_2020_v1.png", width = 10, height = 10)

```

```{r}
# plot 2, enterococci
bac_tbl %>%
  filter(data_type == "Enterococci") %>%
  # note; use of year for date format is "fake" placeholder
  ggplot(aes(x = as.Date(paste(2014,strftime(date,format="%m-%d"),sep="-")),
                           y = val, 
                           color = as.factor(year))) +
  geom_jitter(size = 2) +
  facet_grid(. ~ location, scales = "free_y", labeller = labeller(location = label_wrap_gen(5))) +
  xlab("") +
  ylab("Individual Sample\nConcentration (CFU/100 mL)") +
  ylim(0,625) +
  scale_color_discrete(name = "Year") +

  # single-sample threshold
 # geom_hline(aes(yintercept = 130, linetype =  "Raw seafood consumption\n(130 CFU/100 mL)"), color = "blue") +
  scale_linetype_manual(name = "Threshold", values = c(2, 2),
                        guide = guide_legend(override.aes = list(color = c("blue")))) +
  # overall theme
  theme_bw() +
  theme(axis.text.x = element_text(vjust = 1,hjust = 1, angle = 35),
        strip.text.y = element_text(angle = 0)) +
  ggtitle("Enterococci Concentrations") +
  points_theme

# save plot
ggsave("output/enterococci_conc_2019_2020.png", width = 10, height = 4)


# plot 3, fecal coliform
bac_tbl %>%
  filter(data_type == "Fecal Coliform") %>%
  # note; use of year for date format is "fake" placeholder
  ggplot(aes(x = as.Date(paste(2014,strftime(date,format="%m-%d"),sep="-")),
                           y = val, 
                           color = as.factor(year))) +
  geom_jitter(size = 2) +
  facet_grid(. ~ location, scales = "free_y", labeller = labeller(location = label_wrap_gen(5))) +
  xlab("") +
  ylab("Individual Sample\nConcentration (CFU/100 mL)") +
  scale_color_discrete(name = "Year") +

  # single-sample thresholds
  geom_hline(aes(yintercept = 31, linetype =  "Raw Seafood Consumption\n(31 CFU/100 mL)"), color = "blue") +
  geom_hline(aes(yintercept = 400, linetype =  "Water recreation, secondary\n(400 CFU/100 mL)"), color = "red") +
  scale_linetype_manual(name = "Threshold", values = c(2, 2),
                        guide = guide_legend(override.aes = list(color = c("blue","red")))) +
  # overall theme
  theme_bw() +
  theme(axis.text.x = element_text(vjust = 1,hjust = 1, angle = 35),
        strip.text.y = element_text(angle = 0)) +
  points_theme +
  ggtitle("Fecal Coliform Concentrations")

# save plot
ggsave("output/fecal_coliform_conc_2019_2020.png", width = 10, height = 4)

```

<br>

------------------------------------------------------------------------

### Exeedence Frequency

Define ADEC threshold values

-   Enterococci:

    -   "In a 30-day period, the geometric mean of samples may not exceed 35 enterococci CFU/100 mL, and not more than 10% of the samples may exceed a statistical threshold value (STV) of 130 CFU/100 mL."

-   Fecal coliform:

    -   "Harvest for consumption of raw mollusks or other raw seafood: The geometric mean of samples may not exceed 14 fecal coliform/100 ml; and not more than 10% of the samples may exceed 31 CFU/100 mL for a membrane filtration test."

    -   "Water recreation, secondary: In a 30-day period, the geometric mean of samples may not exceed 200 fecal coliform/100 mL, and not more than 10% of the samples may exceed 400 fecal coliform/100 mL."

<br>

General Data Notes

-   For geometric mean calculations, non-detect values were assigned 50% their method detection limit: See section 2.4.1 of ADEC "Listing Methodology for Determining Water Quality Impairments from Pathogens": "It is appropriate to consider non-detect samples when calculating the geometric mean for assessment purposes. Rather than eliminating the "non-detects" from the assessment data, these results and sample results measured below the detection limit will be calculated as 50% of the method detection limit. This approach may not be appropriate during the analysis of water quality trends."

<br>

Calculate 30-day rolling geometric mean values for Enterococci and Fecal Coliform concentrations

```{r}
dat  <- dat %>%
  filter(data_type %in% c("Fecal Coliform","Enterococci")) %>%
  mutate(year = year(date)) %>%
  transform(val = as.numeric(val)) %>%
  # use 50% of value if it has an "Undetected" qualifier
  mutate(val = ifelse(is.na(qualifier),val,
                      ifelse(qualifier == "U",(val*.5),val))) %>%
  group_by(data_type,location,year) %>%
  arrange(year,data_type,location,date) %>%
  # calculate 30 day rolling geometric means
  mutate(gm30 = rollapplyr(val, 1:n() - findInterval(date - days(30), date), 
                           geometric.mean, fill = NA, partial = T)) %>%
  
  # mutate values from the first annual 30 days of sampling to NA. (We need 30 days for a 30-day rolling geometric mean value).
  mutate(gm30 = as.numeric(ifelse(date < min(date + days(30)),"",gm30)))

```

<br>

Assign exceedence criteria for 30-day geometric means and indivdual sample values

```{r}
# create columns of exceedence occurences
dat  <- dat %>%
  # individual sample exceedence assignments (not considering 30-day prior data yet)
  mutate(indv_excd = case_when(
    (val < 130 & data_type == "Enterococci") ~ "no_indv_excd",
    (val >= 130 & data_type == "Enterococci") ~ "ec_excd_130",
    (val < 31 & data_type == "Fecal Coliform") ~ "no_indv_excd",
    (val >= 31 & val < 400 & data_type == "Fecal Coliform") ~ "fc_excd_31",
    (val >= 400 & data_type == "Fecal Coliform") ~ "fc_excd_400"))  %>%
     # 30-day rolling geometric mean value exceedence assignments
  mutate(gm30_excd = case_when(
    (gm30 < 35 & data_type == "Enterococci") ~ "no_gm_excd",
    (gm30 >= 35 & data_type == "Enterococci") ~ "gm_ec_excd_35",
    (gm30 < 14 & data_type == "Fecal Coliform") ~ "no_gm_excd",
    (gm30 >= 14 & gm30 < 200 & data_type == "Fecal Coliform") ~ "gm_fc_excd_14",
    (gm30 >= 200 & data_type == "Fecal Coliform") ~ "gm_fc_excd_200")) %>%

  # prep for next steps
  mutate(obs = 1) %>%
  group_by(data_type,location,year) %>%
  
  # how many samples do we have from the last 30 days?
  mutate(grp_sample_ct = rollapplyr(obs, 1:n() - findInterval(date - days(30), date), 
                           sum, fill = NA, partial = T)) %>%
  
  # apply numeral if individual sample exceedence observed
  mutate(indv_excd_ct = case_when(
    (indv_excd != "no_indv_excd" ~ 1))) %>%
  ungroup() %>%
  select(location,year,date,data_type,gm30,val,gm30_excd,indv_excd,grp_sample_ct, indv_excd_ct) %>%
  
  # spread individual exceedence classes in to columns
  spread(indv_excd, indv_excd_ct) %>%
  group_by(location,year,data_type) %>%
    
  # replace NAs with zeros so that rollapplyr can work in the next step
  mutate_at(vars(ec_excd_130,fc_excd_31,fc_excd_400), ~replace_na(., 0)) %>%
  arrange(location,data_type,date) %>%
  
  # for each individual sample exceedence class, what percentage of samples have exceeded thresholds over the last 30 days?
  ## enterococci > 130
  mutate(ec_excd_130_30day_pct = ((rollapplyr(ec_excd_130, 1:n() - findInterval(date - days(30), date), 
                                           sum, fill = NA, partial = T)) / grp_sample_ct) * 100) %>%
  ## fecal coliform > 31
  mutate(fc_excd_31_30day_pct = ((rollapplyr(fc_excd_31, 1:n() - findInterval(date - days(30), date), 
                                           sum, fill = NA, partial = T)) / grp_sample_ct) * 100) %>%
  ## fecal coliform > 400
  mutate(fc_excd_400_30day_pct = ((rollapplyr(fc_excd_400, 1:n() - findInterval(date - days(30), date), 
                                           sum, fill = NA, partial = T)) / grp_sample_ct) * 100) %>%
  
  # if >10% of individual samples in prior 30 days have exceeded thresholds, assign exceedence classification 
  ## we know 30 days of data is present if a gm30 value exists
  mutate(indv_excd = ifelse(is.na(gm30),"",
                            case_when(
                              (ec_excd_130_30day_pct > 10) ~ "ec_excd_130",
                              (fc_excd_400_30day_pct > 10 & fc_excd_31_30day_pct != 0) ~ "fc_excd_400",
                              (fc_excd_31_30day_pct > 10) ~ "fc_excd_31"))) %>%
  
  
  # question: is it possible;  or necessary here to reatin % of samples in prev 30 days that exceeded thresholds?  and plot it vs time
  
  
  # retain useful columns
  select(location,year,data_type,date,gm30,val,gm30_excd,indv_excd) %>%
  
  # fill in "no exceedence" observations with character designation
  mutate(gm30_excd = ifelse(is.na(gm30_excd),"no_gm_excd",gm30_excd)) %>%
  mutate(indv_excd = ifelse(indv_excd == "","no_indv_excd",indv_excd)) %>%
  mutate(indv_excd = ifelse(is.na(indv_excd),"no_indv_excd",indv_excd))

# there must be a better way to do this with nested tibbles and/or functions?  

```

<br>

Create figure of day or year vs exceedence observation. Highlight start/stop of dipnet sesason

```{r fig.height=10}

# min and max sample dates within  the 2019-2020 sample seasons
minmaxdates <- dat %>%
  ungroup() %>%
  mutate(day = yday(date)) %>%
  summarise(mindate = min(day),
            maxdate = max(day))

# tile plot
(tileplot <- dat %>%
    
 # prep data for plotting
  select(location,data_type,date,year,indv_excd,gm30_excd) %>%
  pivot_longer(cols = c("indv_excd","gm30_excd"),names_to = "excd_class", values_to = "excd_val") %>%
  filter(!is.na(excd_val)) %>%
  mutate(day = yday(date),
         date = ymd(date)) %>%

# tile plot  
    ggplot(aes(as.factor(date),excd_val)) +
    geom_raster(aes(fill = excd_val)) +
    facet_grid(location ~ year, scales = "free_x", labeller = labeller(location = label_wrap_gen(5))) +
    xlab("") +
    ylab("") +
    #scale_x_date(labels = date_format("%b-%d")) +
    theme_bw() +
    points_theme +
     theme(strip.text.y = element_text(angle = 0),
           axis.text.x = element_text(angle = 50, size = 10, margin = margin(t=20)),
           axis.text.y = element_blank(),
           legend.direction = "vertical",
           legend.position = "bottom") +
    scale_y_discrete(breaks=NULL) +
    
    # modify legend text
    scale_fill_manual(name="Exceedence Type (CFU/100 mL)\n18 AAC 70 Alaska Water Quality Standards (Amended as of April 6, 2018)\nBacteria, for Marine Water Uses",
                      breaks = c("ec_excd_130",
                                 "gm_ec_excd_35",
                                 "fc_excd_31",
                                 "gm_fc_excd_14",
                                 "fc_excd_400"),
                      labels = c("Contact Recreation (10% of Enterococci Samples > 130 in Prior 30 Days)",
                                 "Contact Recreation (30-Day Geometric Mean Enterococci > 35)",
                                 "Raw Aquatic Life Consumption (10% of Fecal Coliform Samples > 31 in Prior 30 Days)",
                                 "Raw Aquatic Life Consumption (30-Day Geometric Mean Fecal Coliform > 14)",
                                 "Secondary Recreation (10% of Fecal Coliform Samples > 400 in Prior 30 Days)"),
                      values=c("red","blue", "green", "purple","orange","white","white")) 
)

# save plot
ggsave("output/exceedence_extents.png", width = 10, height = 11)

# to do: figure out how to reorder factors to match order in legend


```

<br>

--future goal: use "heat map calendar" format: <https://vietle.info/post/calendarheatmap/>

<br>

Export data table used to generate above figure

```{r}
# prep table
excd_tbl <- dat %>%
  mutate(gm30_excd = ifelse(gm30_excd == "no_gm_excd","",gm30_excd)) %>%
  mutate(indv_excd = ifelse(indv_excd == "no_indv_excd","",indv_excd)) %>%
  transform(gm30 = format(round(as.numeric(gm30),1)) ) %>%
  mutate(gm30 = ifelse(gm30 == "   NA","",gm30)) %>%
  mutate(gm30_excd = case_when(
    (gm30_excd == "gm_fc_excd_14") ~ "> 14",
    (gm30_excd == "gm_ec_excd_35") ~ "> 35")) %>%
  mutate(indv_excd = case_when(
    (indv_excd == "fc_excd_31") ~ "> 31",
    (indv_excd == "ec_excd_130") ~ "> 130",
    (indv_excd == "fc_excd_400") ~ "> 400")) %>%
   # replace NAs with blank spaces
  mutate_at(vars(gm30_excd,indv_excd), ~replace_na(., "")) %>%
  rename(Location = location,
         Year = year,
         Bacteria = data_type,
         Date = date,
         `30 Day Geometric Mean Value` = gm30,
         `Individual Sample Value` = val,
         `30 Day Geometric Mean Exceedence` = gm30_excd,
         `10% of Individual Samples in Prior 30 Days Exceedence` = indv_excd) 
 

# save table
write.csv(excd_tbl,"output/exceedence_table.csv", row.names = F)

```

<br>

Plot exceedence of geometric mean thresholds

```{r}

# gm30 enterococci
dat %>%
  filter(data_type == "Enterococci") %>%
  # note; use of year for date format is "fake" placeholder
  ggplot(aes(x = as.Date(paste(2014,strftime(date,format="%m-%d"),sep="-")),
                           y = gm30, 
                           color = as.factor(year))) +
  geom_jitter(size = 2) +
  facet_grid(. ~ location, scales = "free_y", labeller = labeller(location = label_wrap_gen(5))) +
  xlab("") +
  ylab("30-Day Geometric Mean\nConcentration (CFU/100 mL)") +
  ylim(0,150) +
  scale_color_discrete(name = "Year") +

  # single-sample threshold
  geom_hline(aes(yintercept = 35, linetype =  "Raw Aquatic Life Consumption\n(35 CFU/100 mL)"), color = "blue", size = 2) +
  scale_linetype_manual(name = "Enterococci Threshold", values = c(2, 2),
                        guide = guide_legend(override.aes = list(color = c("blue")))) +
  # overall theme
  theme_bw() +
  theme(axis.text.x = element_text(vjust = 1,hjust = 1, angle = 35),
        strip.text.y = element_text(angle = 0)) +
  ggtitle("Enterococci") +
  points_theme


# save plot
ggsave("output/enterococci_gm30conc_2019_2020.png", width = 10, height = 4)


# gm30 fecal coliform
bac_tbl %>%
  filter(data_type == "Fecal Coliform") %>%
  # note; use of year for date format is "fake" placeholder
  ggplot(aes(x = as.Date(paste(2014,strftime(date,format="%m-%d"),sep="-")),
                           y = val, 
                           color = as.factor(year))) +
  geom_jitter(size = 2) +
  facet_grid(. ~ location, scales = "free_y", labeller = labeller(location = label_wrap_gen(5))) +
  xlab("") +
  ylab("30-Day Geometric Mean\nConcentration (CFU/100 mL)") +
  scale_color_discrete(name = "Year") +

  # single-sample thresholds
  geom_hline(aes(yintercept = 14, linetype =  "Raw Aquatic Life Consumption\n(14 CFU/100 mL)"), color = "black", size = 2) +
  geom_hline(aes(yintercept = 200, linetype =  "Water recreation, secondary\n(200 CFU/100 mL)"), color = "red", size = 2) +
  scale_linetype_manual(name = "Fecal Coliform Threshold", values = c(2, 2),
                        guide = guide_legend(override.aes = list(color = c("black","red")))) +
  # overall theme
  theme_bw() +
  theme(axis.text.x = element_text(vjust = 1,hjust = 1, angle = 35),
        strip.text.y = element_text(angle = 0)) +
  points_theme +
  ggtitle("Fecal Coliform")

# save plot
ggsave("output/fecal_coliform_gm30conc_2019_2020.png", width = 10, height = 4)

```

<br>

What was the range of geometric mean values?

```{r}
# by year
(summ_tbl <- dat %>%
  group_by(location,data_type,year) %>%
  filter(!is.na(gm30)) %>%
  summarise(gm30_mean = mean(gm30),
            gm30_se = std.error(gm30),
            gm30_max = max(gm30),
            gm30_min = min(gm30)))

# save
write.csv(summ_tbl, "output/mean_min_max.csv", row.names = F)

# overall
dat %>%
  group_by(data_type) %>%
  filter(!is.na(gm30)) %>%
  summarise(gm30_mean = mean(gm30),
            gm30_max = max(gm30),
            gm30_min = min(gm30))

```

<br>

Create table; calculate % exceedance frequency by site, year, and bacteria type for individual samples

```{r fig.height=8}

# % of days exceeding criteria for individual sample values
indv_pct <- dat %>%
  group_by(location,year,data_type) %>%
  count(indv_excd) %>%
  mutate(pct = prop.table(n)) %>%
  arrange(data_type,location,year,indv_excd) %>%
  filter(indv_excd != "no_indv_excd") %>% 
  rename(excd_type = indv_excd) %>%
  select(-n)

# pct of days exceeding criteria for gm30 values
gm30_pct <- dat %>%
  filter(!is.na(gm30)) %>%
  group_by(location,year,data_type) %>%
  count(gm30_excd) %>%
  mutate(pct = prop.table(n)) %>%
  arrange(data_type,location,year,gm30_excd) %>%
  filter(gm30_excd != "no_gm_excd")  %>%
  rename(excd_type = gm30_excd) %>%
  select(-n)

# % of days exceeding criteria
tbl <- bind_rows(gm30_pct,indv_pct) %>%
  arrange(location,data_type,year) %>%
  transform(year = as.factor(year)) 

# prep table for report
tbl1 <- tbl %>%
  adorn_pct_formatting() %>%
  rename(Location = location,
         Year = year,
         Bacteria = data_type,
         `Exceedence (CFU/mL)` = excd_type,
         `% of Sample Days in Exceedence` = pct) %>%
  mutate(`Exceedence (CFU/mL)` = str_replace_all(`Exceedence (CFU/mL)`,c("gm_fc_excd_14" = "30 Day Geometric Mean > 14",
                                                   "fc_excd_31" = "10% of Samples from Prior 30 Days > 31",
                                                   "gm_ec_excd_35" = "30 Day Geometric Mean > 35",
                                                   "ec_excd_130" = "10% of Samples from Prior 30 Days > 130",
                                                   "fc_excd_400" = "10% of Samples from Prior 30 Days > 400")))


# print table
datatable(tbl1,
          filter = 'top', 
          options = list(pageLength = 5, autoWidth = TRUE))


# save table
write.csv(tbl1,"output/tbl_pct_days_excd.csv", row.names = F)

# note that % days calculations includes only days after 30-days of data is available; not first 4-5 sampling events not included.  we can not include the prior 30 days becuase we need 30 days of prior data to determine exceedences

```

<br>

Plot % of sample days in exceedance by exceedance type for each site/year

```{r fig.height=10}
# plot
tbl %>%
  mutate(excd = paste(data_type,excd_type)) %>%
  ggplot(aes(data_type,pct, fill = excd)) +
  geom_col(position = position_dodge2(preserve = "single")) +
  facet_grid(location ~ year, labeller = labeller(location = label_wrap_gen(5))) +
 
  xlab("") +
  ylab("Percent (%) of Sample Days With Exceedance") +
  scale_y_continuous(breaks=seq(0, 1, .5), labels = scales::percent) +  # Ticks from 0-10, every 
  theme_bw() +
  theme(axis.text.x = element_text(vjust = 1),
        strip.text.y = element_text(angle = 0)) +
  theme(legend.direction = "vertical",
           legend.position = "bottom") +
  points_theme +
  
    # modify legend text
    scale_fill_manual(name ="Exceedence Type (CFU/100 mL)\n18 AAC 70 Alaska Water Quality Standards (Amended as of April 6, 2018)\nBacteria, for Marine Water Uses",
                      breaks = c("Enterococci ec_excd_130",
                                 "Enterococci gm_ec_excd_35",
                                 "Fecal Coliform fc_excd_31",
                                 "Fecal Coliform gm_fc_excd_14",
                                 "Fecal Coliform fc_excd_400"),
                      labels = c("Contact Recreation (10% of Enterococci Samples > 130 in Prior 30 Days)",
                                 "Contact Recreation (30-Day Geometric Mean Enterococci > 35)",
                                 "Raw Aquatic Life Consumption (10% of Fecal Coliform Samples > 31 in Prior 30 Days)",
                                 "Raw Aquatic Life Consumption (30-Day Geometric Mean Fecal Coliform > 14)",
                                 "Secondary Recreation (10% of Fecal Coliform Samples > 400 in Prior 30 Days)"),
                      values=c("red","purple","blue","orange","green"))

# save
ggsave("output/pct_days_excd.png", width = 10, height = 11)
```



------------------------------------------------------------------------

------------------------------------------------------------------------

<br>

